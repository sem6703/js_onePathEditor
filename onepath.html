<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="data:image/gif;base64,R0lGODlhEAAQAPcAAP///ykoKUVJUbq/xSIhIwAAAB02WDRWjqSepy0wNgQEDThOaB5FhAcAO5masztIUgMMIDxXdytWlAAADgcAPgkMO2Nia1RgbwAHGgAIEQACBhgqQ1iKuzFgoRQMQiIkUwAADxsWRF1YVQAIGgMTJwMYJgAGDAIJGVF5pDJhogAADBMLQicofikW4zwp5Doun21tbR8tQQkZLgAJEwAEEFyDtTpwsw8KPycqWCQSnCwasD4uqmppaQsCACMrOhImQ2yTxUB7vg0IPy4sWgAAIwYAIicfWPf39yEdHQcAABkdIyI/YoCizkyHzA8JRDAqXwAANgwBMCkiXPb19QMAAAgAAAkGAhopPJ+11ViW3wAAGRULTjYtbDEgrAIAXSoka7m4tgkCABIHAA8AAHVoX2Ke4gAAIhkOVTInbAsE0k06/1hL2mxraw8MFgAAEToyO3Sz+QAAKBgOUzIkWwAATgAAqjcyyiUkJRITIAAFMCUWGJLJ/wAAKQ0FTCETbRQKoHZh8rqz8vr7+wsQPJHG/wAAGgAAIE1FfNHS8b6+vQoeRI+s0HiCmYB+flZUU7S0tAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQFewAAACwAAAAAEAAQAAAI0QABCBwIg8eRgQgTiihQAMmUhAkvjGDIEAxEgQ8wkIjRgyIbiAkKZCghw0cSKgzvCBpIgKEGEzN+KKkShmIiAAEo6lxiRUwbPAwbCSigAMKGEzQYXhnjJs8gRY4GGFgQgQOKGkCYYCHzRg/DRwAOMJDQIYWNIE2ylIGzh9AigQgKTJiggi4ILWbi8CnEaGADCh5W3BDiZMsZOX0MIXRQ4QMLHEOecEEzx8+hhAxb5CACpUsaOn8QJbQAwoWOIlG8qKkD6GKIFzuMSPmyxk6ggQEBADs=">
  
  
  <title>One Path Editor</title>
  <style>
*:not(hr), *::after, *::before {box-sizing: border-box;margin:0;padding:0;border:0}ul {list-style-type: none}  
#i{padding: 33px 0;background: linear-gradient(rgba(0,0,0,0.9), blue); 
		text-align: center;
		}
#pod,#svg{position:absolute; top:0;left:0;}
#man{
	margin:0 auto;
	width:fit-content;color: black;
	text-align:left;
	}
#lab{display: inline-block;padding: 1px 12px; color: blue;background: #eee;}	
  </style>  
</head>
<body text=pink bgcolor=white>
<div id=i>
	<button id="bph" style="position: relative;">
		<svg width="150" height="150" viewBox="0 0 150 150" fill="yellow">
		<rect x="0" y="0" width="100%" height="100%" fill="white" />
		</svg>

		<svg id="pod" width="150" height="150" viewBox="0 0 150 150" fill="yellow">
		</svg>

		<svg id="svg" width="150" height="150" viewBox="0 0 150 150" fill="yellow">
		</svg>
	</button><br>
	<span id="sn"></span><br>
	<span id="si"></span><br>

	<label id="lab" onclick="svg.style.display=(show.checked)?'none':'block'">
		<input type="checkbox" id="show" style="display: none;">
		show
	</label>
</div>


<div id="man">
	<ul>
		<li>Курсорные клавиши - перемещение точки</li>
		<li>ЛКМ - добавление/выделение точки</li>
		<li>ПКМ - сглаживание точки</li>
		<li>Show - скрыть/показать разметку</li>
	</ul>
</div>



<script>
let a=[];
let bz=[];
let c=-1;
let s;

const fly=()=>{
	let cj=true;
	let s=	
		'<defs>\n'+
		'	<clipPath id="cross">'+
		'		<path d="M'+
		a.map((i,j)=>{
			let d=((!bz[j]&&cj)?'C':'')+(((j>0)&&bz[j]&&cj)?'L':'')+
			(i.x)+' '+(i.y);
			cj=bz[j];
			return d
			}).join(', ')+
		' z" stroke="navy" stroke-width="2"/>'+
		'	</clipPath>\n'+
		'</defs>\n'+				
		'<image x="-20" y="5" width="200" height="200" xlink:href="png.png" clip-path="url(#cross)"/>\n';
	sn.innerText=s;
	pod.innerHTML=s;
}

const vw=()=>{
	s=a.map((i,j)=>
	'<circle r="3" cx="'+(i.x)+
	'" cy="'+(i.y)+
	'" fill="'+((bz[j])?'violet':'red')+'"/>'	
	).join('\n');
	svg.innerHTML=	
	'<rect x="'+(a[c].x-5)+'" y="'+(a[c].y-5)+'" width="10" height="10" fill="none" stroke="red"/>'
	+s;
}

const fa=(g)=>{
	bz[g]=!bz[g];	
	let n;
	let err=false;
	for (let i=0;i<a.length;i++){if (!bz[i]){n++;}else{n=0}; if(n>2){err=true}}
	bz[0]=true;
	if(err){bz[g]=!bz[g]; }// откат если слишком много дуг подряд
}


svg.addEventListener('click',(e)=>{
	const o={x:e.clientX-bph.offsetLeft,y:e.clientY-bph.offsetTop+window.pageYOffset};
	// попал в заповедную зону
	let g=-1;// нарушитель
	for (let i=0;i<a.length;i++)if(((a[i].x-o.x)*(a[i].x-o.x)+(a[i].y-o.y)*(a[i].y-o.y))<160)g=i;
	if (g>-1)
		{
			c=g;	
			vw();
			fly();
		}
		else
		{
			a.push(o);
			c=a.length-1;
			bz.push(true);	
			vw();
			fly();
			si.innerHTML=c;
		}
	});
//*********************************************************
// сглаживание точки
svg.oncontextmenu=(e)=>{
	const o={x:e.clientX-bph.offsetLeft,y:e.clientY-bph.offsetTop+window.pageYOffset};
	let g=-1;// нарушитель
	for (let i=0;i<a.length;i++)if(((a[i].x-o.x)*(a[i].x-o.x)+(a[i].y-o.y)*(a[i].y-o.y))<160)g=i;
	if (g>-1)
		{
			c=g;	
			fa(g);
			si.innerHTML=c;	
			vw();
			fly();
		}
	return false;// аналог e.preventDefault();	
	};
 //********************* выбранная точка перемещается курсорными клавишами
 document.addEventListener('keydown', (e) => {// ←↑↓→

	switch(e.keyCode) {
		case 40: //↓
			if(c>-1)
				{
				a[c].y++;
				e.preventDefault();
				break;
				}
		
		case 38: //↑
			if(c>-1)
				{	
				a[c].y--;
				e.preventDefault();
				break;
				}		  
		case 39: //→
			if(c>-1)
				{	
				a[c].x++;
				e.preventDefault();
				break;
				}	
		case 37: //←
			if(c>-1)
				{	
				a[c].x--;
				e.preventDefault();
				break;
				}		

		case 96: if(c>-1){fa(c)}// numpad0		
		default: break;
	}// switch
	vw();
	fly();	  
	});
//**************************
</script>   
</body>
</html>
